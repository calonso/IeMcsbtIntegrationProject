# Add a storage layer to our app

## Steps:

### Step 1: Install Flask-SQLAlchemy
1. Add `Flask-SQLAlchemy` as a dependency to your app by adding it into `requirements.txt`

### Step 2: Define Your Models
1. Create a new Python file for your models (e.g., `models.py`) in the same directory as your Flask app.
1. Define a model by extending `db.Model` and adding its properties:
```python
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

class WatchedEpisode(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, nullable=False)
    episode_id = db.Column(db.Integer, nullable=False)
    progress = db.Column(db.Integer, nullable=False)

    def dict(self):
        return {
            'id': self.id,
            'user_id': self.user_id,
            'episode_id': self.episode_id,
            'progress': self.progress
        }
```

### Step 3: Configure Your Flask Application for SQLAlchemy
1. Open your Flask application's main file (e.g., app.py or main.py).
1. Import SQLAlchemy
```python
from flask_sqlalchemy import SQLAlchemy
```
1. Add SQLAlchemy configuration to your `app.py`:
```python
from models import db
...
app.config['SQLALCHEMY_DATABASE_URI'] = 'path/to/your/db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db.init_app(app)
```

### Step 4: Open your database and create the required tables
1. ssh to your database
1. Create the table
```sql
CREATE TABLE watched_episode (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 START WITH 1 PRIMARY KEY,
    user_id NUMBER NOT NULL,
    episode_id NUMBER NOT NULL,
    progress NUMBER NOT NULL
);
```

### Step 5: Use Models in Your Application
1. Let's now create an endpoint to update the progress a user has made while watching an episode
```python
from models import WatchedEpisode

def get_or_create_watched_episode(user_id, episode_id):
    # Try to find an existing record
    watched_episode = WatchedEpisode.query.filter_by(user_id=user_id, episode_id=episode_id).first()
    
    # If it doesn't exist, create a new one
    if not watched_episode:
        watched_episode = WatchedEpisode(user_id=user_id, episode_id=episode_id, progress=0)
        db.session.add(watched_episode)
        db.session.commit()
    
    return watched_episode


...
@app.route('/continue-watching/update-progress/<user_id>/<episode_id>/<progress>')
def update_progress(user_id, episode_id, progress):
    # Get or create the watched episode record
    watched_episode = get_or_create_watched_episode(user_id, episode_id)
    
    # Update the progress
    watched_episode.progress = new_progress
    db.session.commit()

    # Return the json representation of the updated episode
    return jsonify(watched_episode.dict())
```





